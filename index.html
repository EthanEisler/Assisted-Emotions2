<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Communicator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* bg-gray-950 */
        }
        #status-panel, #video-container {
            transition: background-color 0.7s ease, border-color 0.7s ease;
        }
        .icon {
            font-size: 5rem; /* 80px */
            line-height: 1;
        }
        #webcam {
            width: 100%;
            height: auto;
            border-radius: 0.75rem; /* rounded-xl */
            transform: scaleX(-1); /* Mirror the video */
        }
        .live-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-white p-4 md:p-8">

    <div class="w-full max-w-5xl text-center mb-8">
        <h1 class="text-4xl font-bold text-cyan-400">Accessibility Communicator</h1>
        <p class="text-gray-400 mt-2">Real-time, non-verbal communication powered by AI.</p>
    </div>

    <main class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <div id="video-container" class="bg-gray-900 p-6 rounded-2xl shadow-lg border-2 border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-300">Live Camera Feed</h2>
                <div class="flex items-center gap-2 px-3 py-1 bg-red-600 rounded-full text-sm">
                    <div class="w-2 h-2 bg-white rounded-full live-dot"></div>
                    LIVE
                </div>
            </div>
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div id="status-panel" class="bg-gray-900 p-6 rounded-2xl shadow-lg border-2 border-gray-700 flex flex-col justify-center">
            <div class="flex flex-col items-center border-b-2 border-gray-700 pb-6">
                <h2 class="text-2xl font-semibold text-gray-300 mb-4">Current Emotional State</h2>
                <div id="emotion-icon" class="icon">üòê</div>
                <p id="emotion-text" class="text-xl mt-4 font-medium text-gray-300">Neutral</p>
            </div>

            <div class="flex flex-col items-center pt-6 mt-2">
                <h2 class="text-2xl font-semibold text-gray-300 mb-4">Communicator Card</h2>
                <div id="card-icon" class="icon">‚ö™</div>
                <p id="card-text" class="text-xl mt-4 font-medium text-gray-300">No card detected</p>
            </div>
        </div>
    </main>
    
    <!-- This is the status message element that will be updated -->
    <p id="status" class="mt-8 text-gray-500 h-6 font-semibold">Connecting to AI Server...</p>
    
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // --- Elements ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');
        const statusPanel = document.getElementById('status-panel');
        const videoContainer = document.getElementById('video-container');
        
        const emotionIcon = document.getElementById('emotion-icon');
        const emotionText = document.getElementById('emotion-text');
        
        const cardIcon = document.getElementById('card-icon');
        const cardText = document.getElementById('card-text');

        // IMPORTANT: Remember to use your deployed backend URL here!
        const API_URL = 'https://samuelyoon-projectclarity.hf.space/process_frame'; 
        // For local testing: const API_URL = 'http://127.0.0.1:5000/process_frame';
        
        let isProcessing = false;
        // ** NEW: A flag to track if we have successfully connected at least once. **
        let isConnected = false;
        
        const EMOTION_MAP = {
            happy: { icon: 'üòä', text: 'Happy / Content', color: '#10B981' }, // Green-500
            sad: { icon: 'üòü', text: 'Sad / Distressed', color: '#3B82F6' }, // Blue-500
            neutral: { icon: 'üòê', text: 'Neutral', color: '#4B5563' } // Gray-600
        };
        const CARD_MAP = {
            'Help/Pain': { icon: 'üî¥', text: 'Needs Help / In Pain' },
            'Yes/OK': { icon: 'üü¢', text: 'Yes / I am OK' },
            'Food/Drink': { icon: 'üîµ', text: 'Wants Food / Drink' },
            'default': { icon: '‚ö™', text: 'No card detected' }
        };

        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
            } catch (err) {
                status.textContent = '‚ùå Error: Webcam permission denied.';
                status.classList.remove('text-gray-500');
                status.classList.add('text-red-400');
                console.error("Error accessing webcam: ", err);
            }
        }

        async function processFrame() {
            if (video.readyState < 2 || isProcessing) return;
            isProcessing = true;
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const data = await response.json();
                
                // ** NEW: Handle the successful connection message **
                if (!isConnected) {
                    isConnected = true;
                    status.textContent = '‚úÖ Connection to AI Server Successful!';
                    status.classList.remove('text-gray-500', 'text-red-400');
                    status.classList.add('text-green-400');

                    // After a few seconds, change to a general status message
                    setTimeout(() => {
                        status.textContent = 'Analysis is running...';
                        status.classList.remove('text-green-400');
                        status.classList.add('text-gray-500');
                    }, 2500);
                }

                updateUI(data);

            } catch (error) {
                // ** NEW: Handle the connection failure message **
                if (!isConnected) {
                    status.textContent = '‚ùå Error: Cannot connect to the deployed backend.';
                    status.classList.remove('text-gray-500');
                    status.classList.add('text-red-400');
                }
                console.error('Error sending frame to server:', error);
            } finally {
                isProcessing = false;
            }
        }

        function updateUI(data) {
            const emotion = EMOTION_MAP[data.emotion] || EMOTION_MAP['neutral'];
            emotionIcon.textContent = emotion.icon;
            emotionText.textContent = emotion.text;
            
            const panelBorderColor = emotion.color;
            statusPanel.style.borderColor = panelBorderColor;
            videoContainer.style.borderColor = panelBorderColor;

            const card = CARD_MAP[data.card_meaning] || CARD_MAP['default'];
            cardIcon.textContent = card.icon;
            cardText.textContent = card.text;
            
            if (data.card_meaning !== 'default') {
                statusPanel.style.backgroundColor = data.color + '26'; // Adds transparency
            } else {
                 statusPanel.style.backgroundColor = '#111827'; // bg-gray-900
            }
        }

        // --- Main Execution ---
        setupWebcam();
        video.addEventListener('loadeddata', () => {
            // Start processing frames after a short delay to ensure everything is loaded.
            setTimeout(() => {
                setInterval(processFrame, 500);
            }, 500);
        });
    </script>
</body>
</html>
